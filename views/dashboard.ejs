<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <title>Student Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* Light theme (default) */
            --primary: #1976d2;
            --primary-dark: #0d47a1;
            --secondary: #2196f3;
            --accent: #00c853;
            --background: #f5f7fa;
            --card-bg: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #757575;
            --border-color: #e0e0e0;
            --success: #00c853;
            --warning: #ff9800;
            --danger: #f44336;
            --sidebar-bg: #1976d2;
            --sidebar-hover: rgba(255, 255, 255, 0.15);
            --border-radius: 16px;
            --shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            --sidebar-width: 280px;
            --sidebar-collapsed: 70px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e8eaf6 100%);
            color: var(--text-primary);
            line-height: 1.6;
            display: flex;
            min-height: 100vh;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(33, 150, 243, 0.05) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        body::after {
            content: '';
            position: fixed;
            bottom: -50%;
            left: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(156, 39, 176, 0.03) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #1565c0 0%, #0d47a1 100%);
            color: white;
            height: 100vh;
            position: fixed;
            transition: all 0.3s;
            z-index: 100;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-header .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 700;
            color: white;
        }

        .sidebar-header .logo img {
            border-radius: 8px;
        }

        .sidebar-header .logo span {
            color: white;
        }

        .sidebar-menu {
            padding: 15px 0;
            flex: 1;
        }

        .menu-toggle-sidebar {
            background: transparent;
            border: none;
            font-size: 24px;
            color: white;
            cursor: pointer;
            padding: 12px;
            border-radius: 8px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .menu-toggle-sidebar:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(1.1);
        }

        .top-bar-left {
            display: flex;
            align-items: center;
        }

        .menu-item {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: all 0.3s;
            border-left: 4px solid transparent;
            cursor: pointer;
            margin: 4px 0;
            border-radius: 0;
            position: relative;
            overflow: hidden;
        }

        .menu-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: #42a5f5;
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .menu-item:hover::before,
        .menu-item.active::before {
            transform: scaleY(1);
        }

        .menu-item:hover, .menu-item.active {
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            border-left: 4px solid #00c853;
        }

        .menu-item i {
            width: 28px;
            height: 28px;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logout-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            border: none;
            border-radius: 12px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.3);
        }

        .logout-btn:hover {
            background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(25, 118, 210, 0.4);
        }

        .logout-btn i {
            font-size: 20px;
        }

        .sidebar.collapsed .logout-btn {
            padding: 12px 18px;
            justify-content: center;
        }

        .sidebar.collapsed .logout-btn .menu-text {
            display: none;
        }

        .sidebar.collapsed .logout-btn i {
            font-size: 20px;
            margin: 0;
        }

        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            transition: all 0.3s;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
        }

        .top-bar {
            background: linear-gradient(135deg, #004aad 0%, #0066ff 100%);
            box-shadow: var(--shadow);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .toggle-sidebar {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            font-size: 20px;
            color: white;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-weight: 600;
        }

        .user-info .user-role {
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .container {
            flex: 1;
            padding: 25px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: none;
        }

        .card {
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            padding: 30px;
            margin-bottom: 25px;
            position: relative;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 25px;
            text-align: center;
            color: white;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .filter-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .date-range-section {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            margin-bottom: 20px;
            align-items: end;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        select, input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: all 0.3s;
        }

        select:focus, input:focus {
            border-color: var(--secondary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--secondary);
            color: var(--secondary);
        }

        .btn-outline:hover {
            background-color: var(--secondary);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background-color: #e67e22;
        }

        .actions-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: var(--light);
            font-weight: 600;
            color: var(--dark);
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .verified {
            background-color: rgba(46, 204, 113, 0.2);
            color: var(--success);
        }

        .unverified {
            background-color: rgba(231, 76, 60, 0.2);
            color: var(--danger);
        }

        .present {
            background-color: rgba(46, 204, 113, 0.2);
            color: var(--success);
        }

        .absent {
            background-color: rgba(231, 76, 60, 0.2);
            color: var(--danger);
        }

        .action-icons {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--gray);
            font-size: 18px;
            transition: color 0.3s;
        }

        .icon-btn:hover {
            color: var(--secondary);
        }

        .verify-btn:hover {
            color: var(--success);
        }

        .edit-btn:hover {
            color: var(--warning);
        }

        .edit-attendance-btn {
            color: #000 !important;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
        }

        .verify-btn i {
            color: #e74c3c !important;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .verify-btn:hover i {
            color: #c0392b !important;
        }

        .modal-body {
            margin-bottom: 25px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .copyright {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: var(--gray);
            font-size: 14px;
        }

        .dashboard-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .dashboard-card .icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
        }

        .dashboard-card.attendance .icon {
            background: linear-gradient(135deg, #00c853 0%, #00e676 100%);
            color: white;
        }

        .dashboard-card.students .icon {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .dashboard-card.reports .icon {
            background: linear-gradient(135deg, #2196f3 0%, #42a5f5 100%);
            color: white;
        }

        .dashboard-card h3 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #1a1a1a;
        }

        .dashboard-card p {
            color: #757575;
            font-size: 14px;
        }

        .stat-card.blue {
            background: linear-gradient(135deg, #2196f3 0%, #42a5f5 100%);
        }

        .stat-card.green {
            background: linear-gradient(135deg, #00c853 0%, #00e676 100%);
        }

        .stat-card.red {
            background: linear-gradient(135deg, #f44336 0%, #ef5350 100%);
        }

        .stat-card.orange {
            background: linear-gradient(135deg, #ff9800 0%, #ffa726 100%);
        }

        .stat-card.purple {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .stat-card.cyan {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        }

        .stat-card.yellow {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .stat-card.pink {
            background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
        }

        .stat-card .stat-value {
            color: white;
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .stat-card .stat-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .sidebar.collapsed {
            width: var(--sidebar-collapsed);
        }

        .sidebar.collapsed .logo-text,
        .sidebar.collapsed .menu-text {
            display: none;
        }

        .sidebar.collapsed + .main-content {
            margin-left: var(--sidebar-collapsed);
        }

        .attendance-branch {
            position: relative;
            transition: all 0.3s;
        }

        .attendance-branch.dimmed {
            opacity: 0.6;
        }

        .edit-attendance-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            cursor: pointer;
        }

        .attendance-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .attendance-status {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .status-option {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .attendance-options {
            display: flex;
            gap: 10px;
        }

        .attendance-btn {
            width: 40px;
            height: 40px;
            border: 2px solid;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .present-btn {
            border-color: var(--success);
            color: var(--success);
        }

        .present-btn.selected {
            background-color: var(--success);
            color: white;
        }

        .absent-btn {
            border-color: var(--danger);
            color: var(--danger);
        }

        .absent-btn.selected {
            background-color: var(--danger);
            color: white;
        }

        .attendance-summary {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--light);
            border-radius: var(--border-radius);
        }

        .attendance-readonly {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Enhanced Dashboard Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .dashboard-action-card {
            background: white;
            border-radius: 20px;
            padding: 35px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
        }

        .dashboard-action-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.05) 0%, rgba(13, 71, 161, 0.05) 100%);
            opacity: 0;
            transition: opacity 0.4s;
        }

        .dashboard-action-card:hover::before {
            opacity: 1;
        }

        .dashboard-action-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .card-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            position: relative;
            z-index: 1;
        }

        .card-icon.attendance {
            background: linear-gradient(135deg, #00c853 0%, #00e676 100%);
            box-shadow: 0 8px 20px rgba(0, 200, 83, 0.3);
        }

        .card-icon.students {
            background: linear-gradient(135deg, #7b1fa2 0%, #9c27b0 100%);
            box-shadow: 0 8px 20px rgba(156, 39, 176, 0.3);
        }

        .card-icon.reports {
            background: linear-gradient(135deg, #1976d2 0%, #2196f3 100%);
            box-shadow: 0 8px 20px rgba(33, 150, 243, 0.3);
        }

        .dashboard-action-card h3 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-primary);
            position: relative;
            z-index: 1;
        }

        .dashboard-action-card p {
            color: var(--text-secondary);
            font-size: 15px;
            line-height: 1.6;
            position: relative;
            z-index: 1;
        }

        /* Add floating animation */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .card-icon {
            animation: float 3s ease-in-out infinite;
        }

        .dashboard-action-card:nth-child(1) .card-icon {
            animation-delay: 0s;
        }

        .dashboard-action-card:nth-child(2) .card-icon {
            animation-delay: 0.3s;
        }

        .dashboard-action-card:nth-child(3) .card-icon {
            animation-delay: 0.6s;
        }

        /* Make the edit button always visible and clickable */
        .attendance-readonly #edit-attendance-btn {
            opacity: 1 !important;
            pointer-events: auto !important;
        }

        .attendance-readonly #edit-attendance-btn i {
            opacity: 1 !important;
        }

        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: var(--sidebar-collapsed);
            }

            .sidebar .logo-text,
            .sidebar .menu-text {
                display: none;
            }

            .main-content {
                margin-left: var(--sidebar-collapsed);
            }

            .stats-container {
                grid-template-columns: 1fr;
            }

            .filter-section {
                grid-template-columns: 1fr;
            }

            .date-range-section {
                grid-template-columns: 1fr;
            }

            .actions-row {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <!-- Sidebar header with hamburger menu -->
        <div class="sidebar-header">
            <button class="menu-toggle-sidebar" onclick="toggleSidebarFromInside()">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        
        <!-- Sidebar menu -->
        <div class="sidebar-menu">
            <a href="#" class="menu-item active" data-page="dashboard">
                <i class="fas fa-home"></i>
                <span class="menu-text">Dashboard</span>
            </a>
            <a href="#" class="menu-item" data-page="attendance">
                <i class="fas fa-clipboard-check"></i>
                <span class="menu-text">Mark Attendance</span>
            </a>
            <a href="#" class="menu-item" data-page="students">
                <i class="fas fa-user-graduate"></i>
                <span class="menu-text">Manage Students</span>
            </a>
            <a href="#" class="menu-item" data-page="reports">
                <i class="fas fa-chart-line"></i>
                <span class="menu-text">View Reports</span>
            </a>
        </div>
        
        <!-- Sidebar footer with logout -->
        <div class="sidebar-footer">
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-power-off"></i>
                <span class="menu-text">Logout</span>
            </button>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Top bar with logo and user info -->
        <div class="top-bar">
            <div class="top-bar-left">
                <img src="/images/pgplogo.png" alt="PGP Logo" style="width: 45px; height: 45px; border-radius: 8px; margin-right: 15px;">
                <span style="font-size: 20px; font-weight: 700; color: white;">PGP COLLEGES</span>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <div class="user-info">
                    <i class="fas fa-user-circle" style="font-size: 28px;"></i>
                    <div>
                        <div style="font-size: 16px; font-weight: 600;" id="teacher-name">Teacher Name</div>
                        <div class="user-role">Teacher Portal</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Page -->
        <div id="dashboard" class="page active">
            <div class="container">
                <h1 class="page-title">Dashboard</h1>
                
                <div class="card" style="background: linear-gradient(135deg, #ffffff 0%, #f5f7fa 100%); border: none;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h2 style="font-size: 32px; font-weight: 700; color: #1976d2; margin-bottom: 10px;" id="welcome-message">
                            Welcome Back, Teacher
                        </h2>
                        <p style="color: #757575; font-size: 16px;">
                            Select an action to get started with your daily tasks
                        </p>
                    </div>
                    
                    <div class="dashboard-grid">
                        <div class="dashboard-action-card" data-page="attendance">
                            <div class="card-icon attendance">
                                <i class="fas fa-clipboard-check" style="color: white;"></i>
                            </div>
                            <h3>Mark Attendance</h3>
                            <p>Record student attendance for today</p>
                        </div>
                        
                        <div class="dashboard-action-card" data-page="students">
                            <div class="card-icon students">
                                <i class="fas fa-user-graduate" style="color: white;"></i>
                            </div>
                            <h3>Manage Students</h3>
                            <p>Add, edit, or view student records</p>
                        </div>
                        
                        <div class="dashboard-action-card" data-page="reports">
                            <div class="card-icon reports">
                                <i class="fas fa-chart-line" style="color: white;"></i>
                            </div>
                            <h3>View Reports</h3>
                            <p>Generate and download attendance reports</p>
                        </div>
                    </div>
                </div>
                
                <div class="copyright">
                    Copyright © 2025 PGP COLLEGES. All rights reserved
                </div>
            </div>
        </div>
        
        <!-- Mark Attendance Page -->
        <div id="attendance" class="page">
            <div class="container">
                <h1 class="page-title">Mark Attendance</h1>
                
                <div class="card">
                    <h2>Today's Date: <span id="currentDate"></span></h2>
                    
                    <div class="filter-section">
                        <div class="form-group">
                            <label for="attendance-academic-year">Academic Year of Joining *</label>
                            <select id="attendance-academic-year">
                                <option value="">All Academic Year</option>
                                <option value="2018-2019">2018-2019</option>
                                <option value="2019-2020">2019-2020</option>
                                <option value="2020-2021">2020-2021</option>
                                <option value="2021-2022">2021-2022</option>
                                <option value="2022-2023">2022-2023</option>
                                <option value="2023-2024">2023-2024</option>
                                <option value="2024-2025">2024-2025</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="attendance-course-type">Course Type *</label>
                            <select id="attendance-course-type">
                                <option value="">All Course Type</option>
                                <option value="UG">UG</option>
                                <option value="PG">PG</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="attendance-course">Course *</label>
                            <select id="attendance-course">
                                <option value="">All Course</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="attendance-branch">Branch *</label>
                            <select id="attendance-branch">
                                <option value="">All Branch</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="attendance-academic-year-filter">Academic Year *</label>
                            <select id="attendance-academic-year-filter">
                                <option value="">All Academic Year</option>
                                <option value="I">I</option>
                                <option value="II">II</option>
                                <option value="III">III</option>
                                <option value="IV">IV</option>
                            </select>
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="loadAttendanceStudents()">
                        <i class="fas fa-filter"></i> Load Students
                    </button>
                </div>
                
                <div class="card" id="attendance-card">
                    <h2>Student Attendance</h2>
                    <div id="attendance-date" style="margin-bottom: 15px; font-weight: 600;"></div>
                    <button class="edit-attendance-btn" id="edit-attendance-btn" style="display: none; background: none; border: none; cursor: pointer; position: absolute; top: 20px; right: 20px; z-index: 10;">
                        <i class="fas fa-pencil-alt" style="color: #000;"></i>
                    </button>

                    <!-- All Present Button -->
                    <div style="margin-bottom: 15px;">
                        <button class="btn btn-success" id="mark-all-present-btn" onclick="markAllPresent()" style="display: none;">
                            <i class="fas fa-check-double"></i> Mark All Present
                        </button>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Register No</th>
                                <th>Branch</th>
                                <th>Attendance</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody">
                            <!-- Attendance data will be populated here -->
                        </tbody>
                    </table>
                    
                    <div class="attendance-summary">
                        <div style="display: flex; justify-content: space-between;">
                            <div>Total Students: <strong id="total-attendance-count">0</strong></div>
                            <div>Present: <strong id="present-count">0</strong></div>
                            <div>Absent: <strong id="absent-count">0</strong></div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-primary" id="submit-attendance-btn" onclick="submitAttendance()">
                            <i class="fas fa-check"></i> Submit Attendance
                        </button>
                        <button class="btn btn-success" id="update-attendance-btn" onclick="updateAttendance()" style="display: none;">
                            <i class="fas fa-sync-alt"></i> Update Attendance
                        </button>
                    </div>
                </div>
                
                <div class="copyright">
                    Copyright © 2025 PGP. All rights reserved
                </div>
            </div>
        </div>
        
        <!-- Manage Students Page -->
        <div id="students" class="page">
            <div class="container">
                <h1 class="page-title">Manage Students</h1>
                
                <div class="card">
                    <div class="actions-row">
                        <h2>Student Filter</h2>
                        
                        <button class="btn btn-success" onclick="openImportModal()">
                            <i class="fas fa-file-import"></i> Import Students
                        </button>
                        <button class="btn btn-primary" onclick="openAddStudentModal()">
                            <i class="fas fa-plus"></i> Add Student
                        </button>
                    </div>
                    
                    <div class="filter-section">
                        <div class="form-group">
                            <label for="academic-year">Academic Year of Joining *</label>
                            <select id="academic-year">
                                <option value="">All Academic Year</option>
                                <option value="2018-2019">2018-2019</option>
                                <option value="2019-2020">2019-2020</option>
                                <option value="2020-2021">2020-2021</option>
                                <option value="2021-2022">2021-2022</option>
                                <option value="2022-2023">2022-2023</option>
                                <option value="2023-2024">2023-2024</option>
                                <option value="2024-2025">2024-2025</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="course-type">Course Type *</label>
                            <select id="course-type">
                                <option value="">All Course Type</option>
                                <option value="UG">UG</option>
                                <option value="PG">PG</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="course">Course *</label>
                            <select id="course">
                                <option value="">All Course</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="branch">Branch *</label>
                            <select id="branch">
                                <option value="">All Branch</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="manage-academic-year-filter">Academic Year *</label>
                            <select id="manage-academic-year-filter">
                                <option value="">All Academic Year</option>
                                <option value="I">I</option>
                                <option value="II">II</option>
                                <option value="III">III</option>
                                <option value="IV">IV</option>
                            </select>
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="loadStudents()">
                        <i class="fas fa-filter"></i> Filter Now
                    </button>
                </div>
                
                <div class="card">
                    <h2>Student Details</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Action</th>
                                <th>Name</th>
                                <th>Roll No</th>
                                <th>Register No</th>
                                <th>Admission Year</th>
                                <th>Course Type</th>
                                <th>Course</th>
                                <th>Branch</th>
                                <th>Academic Year</th>
                                <th>Verification</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody">
                            <!-- Student data will be populated here -->
                        </tbody>
                    </table>
                    
                    <div class="table-footer">
                        <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                            <div>Items per page: <strong>10</strong></div>
                            <div><strong id="showing-count">0</strong> of <strong id="total-count">0</strong></div>
                        </div>
                    </div>
                </div>
                
                <div class="copyright">
                    Copyright © 2025 PGP. All rights reserved
                </div>
            </div>
        </div>
        
        <!-- View Reports Page -->
        <div id="reports" class="page">
            <div class="container">
                <h1 class="page-title">View Reports</h1>
                
                <div class="card">
                    <div class="actions-row">
                        <h2>Report Filters</h2>
                        <button class="btn btn-primary" onclick="openExportModal()">
                            <i class="fas fa-download"></i> Export Report
                        </button>
                    </div>
                    
                    <div class="filter-section">
                        <div class="form-group">
                            <label for="report-academic-year">Academic Year of Joining *</label>
                            <select id="report-academic-year">
                                <option value="">All Academic Year</option>
                                <option value="2018-2019">2018-2019</option>
                                <option value="2019-2020">2019-2020</option>
                                <option value="2020-2021">2020-2021</option>
                                <option value="2021-2022">2021-2022</option>
                                <option value="2022-2023">2022-2023</option>
                                <option value="2023-2024">2023-2024</option>
                                <option value="2024-2025">2024-2025</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="report-course-type">Course Type *</label>
                            <select id="report-course-type">
                                <option value="">All Course Type</option>
                                <option value="UG">UG</option>
                                <option value="PG">PG</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="report-course">Course *</label>
                            <select id="report-course">
                                <option value="">All Course</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="report-branch">Branch *</label>
                            <select id="report-branch">
                                <option value="">All Branch</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="report-academic-year-filter">Academic Year *</label>
                            <select id="report-academic-year-filter">
                                <option value="">All Academic Year</option>
                                <option value="I">I</option>
                                <option value="II">II</option>
                                <option value="III">III</option>
                                <option value="IV">IV</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="date-range-section">
                        <div class="form-group">
                            <label for="start-date">From Date *</label>
                            <input type="date" id="start-date">
                        </div>
                        
                        <div class="form-group">
                            <label for="end-date">To Date *</label>
                            <input type="date" id="end-date">
                        </div>
                        
                        <div class="form-group">
                            <button class="btn btn-warning" onclick="setTodayRange()">
                                <i class="fas fa-calendar-day"></i> Today
                            </button>
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="generateReport()">
                        <i class="fas fa-chart-bar"></i> Show Report
                    </button>
                </div>
                
                <div class="card">
                    <h2>Attendance Report</h2>
                    <div id="reportSummary">
                        <!-- Report summary will be shown here -->
                    </div>
                    
                    <table id="reportTable">
                        <thead>
                            <tr id="reportTableHeader">
                                <!-- Table headers will be populated here -->
                            </tr>
                        </thead>
                        <tbody id="reportTableBody">
                            <!-- Report data will be populated here -->
                        </tbody>
                    </table>
                    
                    <div class="table-footer">
                        <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                            <div>Items per page: <strong>10</strong></div>
                            <div><strong id="report-showing-count">0</strong> of <strong id="report-total-count">0</strong></div>
                        </div>
                    </div>
                </div>
                
                <div class="copyright">
                    Copyright © 2025 PGP. All rights reserved
                </div>
            </div>
        </div>
    </div>
    
    <!-- Verification Modal -->
    <div id="verificationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Verify Student</h3>
                <button class="close-btn" onclick="closeVerificationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to verify this student's data?</p>
                <p><strong>This action cannot be undone.</strong></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeVerificationModal()">Cancel</button>
                <button class="btn btn-success" onclick="verifyStudent()">Verify</button>
            </div>
        </div>
    </div>
    
    <!-- Add Student Modal -->
    <div id="addStudentModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Add New Student</h3>
                <button class="close-btn" onclick="closeAddStudentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addStudentForm">
                    <div class="form-group">
                        <label for="name">Name *</label>
                        <input type="text" id="name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="rollNo">Roll No *</label>
                        <input type="text" id="rollNo" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="registerNo">Register No *</label>
                        <input type="text" id="registerNo" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="admissionYear">Admission Year *</label>
                        <select id="admissionYear" required>
                            <option value="">Select Admission Year</option>
                            <option value="2018-2019">2018-2019</option>
                            <option value="2019-2020">2019-2020</option>
                            <option value="2020-2021">2020-2021</option>
                            <option value="2021-2022">2021-2022</option>
                            <option value="2022-2023">2022-2023</option>
                            <option value="2023-2024">2023-2024</option>
                            <option value="2024-2025">2024-2025</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="addCourseType">Course Type *</label>
                        <select id="addCourseType" required onchange="updateAddCourseOptions()">
                            <option value="">Select Course Type</option>
                            <option value="UG">UG</option>
                            <option value="PG">PG</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="addCourse">Course *</label>
                        <select id="addCourse" required onchange="updateAddBranchOptions()">
                            <option value="">Select Course</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="addBranch">Branch *</label>
                        <select id="addBranch" required>
                            <option value="">Select Branch</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="academicYear">Academic Year *</label>
                        <select id="academicYear" required>
                            <option value="">Select Academic Year</option>
                            <option value="I">I</option>
                            <option value="II">II</option>
                            <option value="III">III</option>
                            <option value="IV">IV</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeAddStudentModal()">Cancel</button>
                <button class="btn btn-success" onclick="addStudent()">Add Student</button>
            </div>
        </div>
    </div>
    
    <!-- Export Modal -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Export Report</h3>
                <button class="close-btn" onclick="closeExportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Select export format:</p>
                <div class="export-options">
                    <button class="btn btn-success" onclick="exportReport('xlsx')">
                        <i class="fas fa-file-excel"></i> Excel (XLSX)
                    </button>
                    <button class="btn btn-primary" onclick="exportReport('csv')">
                        <i class="fas fa-file-csv"></i> CSV
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeExportModal()">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Import Students Modal -->
    <div id="importModal" class="modal">
        <div class="modal-content" style="max-width: 95%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3 class="modal-title">Import Students (Bulk Upload)</h3>
                <button class="close-btn" onclick="closeImportModal()">&times;</button>
            </div>
            <div class="modal-body" style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                <div style="margin-bottom: 15px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                    <p style="margin: 0; color: #1976d2; font-weight: 600;">
                        <i class="fas fa-info-circle"></i> Instructions:
                    </p>
                    <ul style="margin: 10px 0 0 20px; color: #1976d2;">
                        <li><strong>Easy Excel Paste:</strong> Copy data from Excel and paste directly in the first cell - data will automatically fill correctly!</li>
                        <li><strong>Quick Fill Options:</strong> Select a dropdown value and click "Apply to All" to fill that column for all rows</li>
                        <li>Click "Validate Data" to check for errors before importing</li>
                    </ul>
                </div>
                
                <!-- Spreadsheet Container -->
                <div id="spreadsheet-container" style="flex: 1; overflow: auto; border: 1px solid #ddd; border-radius: 8px;"></div>
                
                <div id="validation-results" style="margin-top: 15px; padding: 10px; border-radius: 8px; display: none;"></div>
            </div>
            <div class="modal-footer" style="justify-content: space-between;">
                <button class="btn btn-outline" onclick="closeImportModal()">Cancel</button>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-warning" onclick="validateImportData()">
                        <i class="fas fa-check-circle"></i> Validate Data
                    </button>
                    <button class="btn btn-success" id="import-submit-btn" onclick="submitImportData()" disabled>
                        <i class="fas fa-upload"></i> Import Students
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://iaoladiqgfxjiijnaxuy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlhb2xhZGlxZ2Z4amlpam5heHV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5ODIzNTcsImV4cCI6MjA3NzU1ODM1N30.6A1_vyEgVOV9QbSwkmYXegcmq4SLPFukG5vbUJzyA5w';
        


        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Course options based on course type
        const courseOptions = {
            UG: ["B.E", "B.Tech"],
            PG: ["M.B.A", "M.C.A", "M.E"]
        };

        // Branch options based on course
        const branchOptions = {
            "B.E": ["ECE", "EEE", "MECH", "CSE", "CIVIL", "BME"],
            "B.Tech": ["AI&DS", "IT"],
            "M.B.A": ["Dual Specialisation"],
            "M.C.A": ["Computer Application"],
            "M.E": ["CSE"]
        };

        // Global variables
        let currentStudentIndex = null;
        let currentStudentId = null;




        // ============================================
// AUTHENTICATION CHECK
// ============================================
async function checkAuth() {
    try {
        // Get session from Supabase
        const { data: { session }, error } = await supabase.auth.getSession();
        
        if (!session) {
            console.log('❌ No session found, redirecting to login');
            window.location.href = '/login';
            return false;
        }

        // Verify the session is still valid
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        
        if (userError || !user) {
            console.log('❌ Invalid session, redirecting to login');
            localStorage.clear();
            window.location.href = '/login';
            return false;
        }

        console.log('✅ Authentication verified for:', user.email);
        return true;

    } catch (error) {
        console.error('❌ Auth check error:', error);
        localStorage.clear();
        window.location.href = '/login';
        return false;
    }
}
        // Update the DOMContentLoaded event in dashboard
       document.addEventListener('DOMContentLoaded', async function() {
    console.log('🔄 Dashboard: DOM loaded');
    
    try {
        // Check authentication first
        const isAuthenticated = await checkAuth();
        if (!isAuthenticated) {
            return;
        }
        
        // If we get here, user is authenticated
        console.log('✅ User authenticated, loading dashboard...');
        
        // Continue with dashboard initialization
        setupEventListeners();
        updateCurrentDate();
        await loadTeacherInfo();
        setupNavigation();
        setDefaultDateRange();
        
        const editBtn = document.getElementById('edit-attendance-btn');
        if (editBtn) {
            editBtn.addEventListener('click', function() {
                enableAttendanceEditing();
            });
        }
        
        window.history.replaceState({ page: 'dashboard' }, '', '/dashboard');
        
    } catch (error) {
        console.error('❌ Dashboard error:', error);
        await logout();
    }
});

         
                
              // ============================================
// MISSING FUNCTIONS - ADD THESE
// ============================================

// Load teacher information
async function loadTeacherInfo() {
    try {
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        
        if (sessionError) throw sessionError;
        
        if (!session) {
            console.log('No active session, redirecting to login...');
            window.location.href = '/login';
            return;
        }
        
        // Get teacher details from teachers table
        const { data: teacher, error: teacherError } = await supabase
            .from('teachers')
            .select('*')
            .eq('user_id', session.user.id)
            .single();
        
        if (teacherError) throw teacherError;
        
        if (teacher && teacher.name) {
            // Update teacher name in top right
            document.getElementById('teacher-name').textContent = teacher.name;
            
            // Update welcome message
            const welcomeMsg = document.getElementById('welcome-message');
            if (welcomeMsg) {
                welcomeMsg.textContent = `Welcome Back, ${teacher.name}`;
            }
            
            console.log('Teacher info loaded:', teacher.name);
        }
        
    } catch (error) {
        console.error('Error loading teacher info:', error);
        window.location.href = '/login';
    }
}

// Logout function
async function logout() {
    try {
        // Sign out from Supabase
        await supabase.auth.signOut();
    } catch (error) {
        console.error('Sign out error:', error);
    } finally {
        // Clear ALL storage
        localStorage.clear();
        sessionStorage.clear();
        
        // Redirect to login page
        window.location.href = '/login';
    }
}

// Toggle sidebar function
function toggleSidebarFromInside() {
    document.querySelector('.sidebar').classList.toggle('collapsed');
}
                
            } catch (error) {
                console.error('Error loading teacher info:', error);
                window.location.href = '/login';
            }
        }

        // Toggle sidebar from inside
        function toggleSidebarFromInside() {
            document.querySelector('.sidebar').classList.toggle('collapsed');
        }

      // Setup navigation - IMPROVED VERSION
function setupNavigation() {
    console.log('🔄 Setting up navigation...');
    
    // Use event delegation for both sidebar menu items and dashboard cards
    document.addEventListener('click', function(e) {
        // Check if clicked element or its parent has data-page attribute
        let target = e.target;
        
        // Traverse up the DOM to find the element with data-page attribute
        while (target && !target.hasAttribute('data-page')) {
            target = target.parentElement;
            if (target === document.body) {
                target = null;
                break;
            }
        }
        
        if (target && target.hasAttribute('data-page')) {
            e.preventDefault();
            const pageId = target.getAttribute('data-page');
            console.log('Navigation clicked:', pageId);
            
            navigateToPage(pageId);
            
            // Update active menu item
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            const menuItem = document.querySelector(`.menu-item[data-page="${pageId}"]`);
            if (menuItem) {
                menuItem.classList.add('active');
            }
        }
    });

    // Add direct click handlers for dashboard cards as backup
    document.querySelectorAll('.dashboard-action-card').forEach(card => {
        card.addEventListener('click', function() {
            const pageId = this.getAttribute('data-page');
            console.log('Dashboard card clicked:', pageId);
            navigateToPage(pageId);
            
            // Update active menu item
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            const menuItem = document.querySelector(`.menu-item[data-page="${pageId}"]`);
            if (menuItem) {
                menuItem.classList.add('active');
            }
        });
    });

    // Add direct click handlers for sidebar menu items as backup
    document.querySelectorAll('.menu-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const pageId = this.getAttribute('data-page');
            console.log('Menu item clicked:', pageId);
            navigateToPage(pageId);
            
            // Update active menu item
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            this.classList.add('active');
        });
    });
}

        // Navigate to page
        function navigateToPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            const page = document.getElementById(pageId);
            if (page) {
                page.classList.add('active');
            }
            
            // Update URL without page reload
            let url = '/';
            if (pageId === 'attendance') {
                url = '/mark-attendance';
            } else if (pageId === 'students') {
                url = '/manage-students';
            } else if (pageId === 'reports') {
                url = '/view-reports';
            } else {
                url = '/dashboard';
            }
            
            // Update browser URL
            window.history.pushState({ page: pageId }, '', url);
            
            // If navigating to reports, update the reports display
            if (pageId === 'reports') {
                generateReport();
            }
        }

        // Handle browser back/forward buttons
        window.addEventListener('popstate', function(event) {
            const path = window.location.pathname;
            let pageId = 'dashboard';
            
            if (path.includes('mark-attendance')) {
                pageId = 'attendance';
            } else if (path.includes('manage-students')) {
                pageId = 'students';
            } else if (path.includes('view-reports')) {
                pageId = 'reports';
            }
            
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Update active menu item
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            const menuItem = document.querySelector(`.menu-item[data-page="${pageId}"]`);
            if (menuItem) {
                menuItem.classList.add('active');
            }
        });

        // Update current date
        function updateCurrentDate() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', options);
            
            // Set attendance date in DD/MM/YYYY format
            const formattedDate = `${String(now.getDate()).padStart(2, '0')}/${String(now.getMonth() + 1).padStart(2, '0')}/${now.getFullYear()}`;
            document.getElementById('attendance-date').textContent = `Date: ${formattedDate}`;
        }

        // Setup event listeners for dynamic dropdowns
        function setupEventListeners() {
            // Filter section for manage students
            document.getElementById('course-type').addEventListener('change', function() {
                updateCourseOptions('course', this.value);
            });

            document.getElementById('course').addEventListener('change', function() {
                updateBranchOptions('branch', this.value);
            });
            
            // Filter section for attendance
            document.getElementById('attendance-course-type').addEventListener('change', function() {
                updateCourseOptions('attendance-course', this.value);
            });

            document.getElementById('attendance-course').addEventListener('change', function() {
                updateBranchOptions('attendance-branch', this.value);
            });
            
            // Filter section for reports
            document.getElementById('report-course-type').addEventListener('change', function() {
                updateCourseOptions('report-course', this.value);
            });

            document.getElementById('report-course').addEventListener('change', function() {
                updateBranchOptions('report-branch', this.value);
            });
// ============================================
// MISSING MODAL FUNCTIONS - ADD THESE
// ============================================

function openImportModal() {
    document.getElementById('importModal').style.display = 'flex';
    initializeSpreadsheet();
}

function closeImportModal() {
    document.getElementById('importModal').style.display = 'none';
    importData = [];
    validatedData = [];
    document.getElementById('import-submit-btn').disabled = true;
    document.getElementById('validation-results').style.display = 'none';
}

function openAddStudentModal() {
    document.getElementById('addStudentModal').style.display = 'flex';
    document.getElementById('addStudentForm').reset();
    // Reset dynamic dropdowns
    document.getElementById('addCourse').innerHTML = '<option value="">Select Course</option>';
    document.getElementById('addBranch').innerHTML = '<option value="">Select Branch</option>';
}

function closeAddStudentModal() {
    document.getElementById('addStudentModal').style.display = 'none';
}

function openExportModal() {
    document.getElementById('exportModal').style.display = 'flex';
}

function closeExportModal() {
    document.getElementById('exportModal').style.display = 'none';
}
        }

        // Update course options based on course type
        function updateCourseOptions(selectId, courseType) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">All Course</option>';
            
            if (courseType && courseOptions[courseType]) {
                courseOptions[courseType].forEach(course => {
                    const option = document.createElement('option');
                    option.value = course;
                    option.textContent = course;
                    select.appendChild(option);
                });
            }
        }

        // Update branch options based on course
        function updateBranchOptions(selectId, course) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">All Branch</option>';
            
            if (course && branchOptions[course]) {
                branchOptions[course].forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch;
                    option.textContent = branch;
                    select.appendChild(option);
                });
            }
        }

        // Update course options in add student form
        function updateAddCourseOptions() {
            const courseType = document.getElementById('addCourseType').value;
            const courseSelect = document.getElementById('addCourse');
            courseSelect.innerHTML = '<option value="">Select Course</option>';
            
            if (courseType && courseOptions[courseType]) {
                courseOptions[courseType].forEach(course => {
                    const option = document.createElement('option');
                    option.value = course;
                    option.textContent = course;
                    courseSelect.appendChild(option);
                });
            }
        }

        // Update branch options in add student form
        function updateAddBranchOptions() {
            const course = document.getElementById('addCourse').value;
            const branchSelect = document.getElementById('addBranch');
            branchSelect.innerHTML = '<option value="">Select Branch</option>';
            
            if (course && branchOptions[course]) {
                branchOptions[course].forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch;
                    option.textContent = branch;
                    branchSelect.appendChild(option);
                });
            }
        }

        // Load students function
        async function loadStudents() {
            try {
                // Show loading state
                const btn = document.querySelector('#students .btn-success');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span class="loading"></span> Loading...';
                btn.disabled = true;
                
                // Get filter values
                const academicYear = document.getElementById('academic-year').value;
                const courseType = document.getElementById('course-type').value;
                const course = document.getElementById('course').value;
                const branch = document.getElementById('branch').value;
                const academicYearFilter = document.getElementById('manage-academic-year-filter').value;
                
                // Build query
                let query = supabase.from('students').select('*');
                
                // Apply filters - USE CORRECT COLUMN NAMES
                if (academicYear) query = query.eq('admissionyear', academicYear);
                if (courseType) query = query.eq('coursetype', courseType);
                if (course) query = query.eq('course', course);
                if (branch) query = query.eq('branch', branch);
                if (academicYearFilter) query = query.eq('academicyear', academicYearFilter);
                
                const { data: students, error } = await query;
                
                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }
                
                populateStudentTable(students || []);
                
                // Restore button
                btn.innerHTML = originalText;
                btn.disabled = false;
                
            } catch (error) {
                console.error('Error loading students:', error);
                alert('Error loading students: ' + error.message);
                
                // Restore button
                const btn = document.querySelector('#students .btn-success');
                btn.innerHTML = '<i class="fas fa-filter"></i> Filter Now';
                btn.disabled = false;
            }
        }

        // Populate student table
        function populateStudentTable(students) {
            const tableBody = document.getElementById('studentTableBody');
            tableBody.innerHTML = '';

            students.forEach((student, index) => {
                const row = document.createElement('tr');
                const isVerified = student.verification === 'VERIFIED';
                
                row.innerHTML = `
                    <td class="action-icons">
                        <button class="icon-btn edit-btn" title="Edit Student" onclick="openEditStudentModal('${student.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${!isVerified ? `
                            <button class="icon-btn verify-btn" title="Verify Student" onclick="openVerificationModal('${student.id}')">
                                <i class="fas fa-exclamation-circle" style="color: #e74c3c;"></i>
                            </button>
                        ` : ''}
                    </td>
                    <td>${student.name}</td>
                    <td>${student.rollnumber}</td>
                    <td>${student.registernumber || ''}</td>
                    <td>${student.admissionyear || ''}</td>
                    <td>${student.coursetype || ''}</td>
                    <td>${student.course || ''}</td>
                    <td>${student.branch || ''}</td>
                    <td>${student.academicyear || ''}</td>
                    <td>
                        <span class="status-badge ${isVerified ? 'verified' : 'unverified'}">
                            ${isVerified ? 'VERIFIED' : 'UNVERIFIED'}
                        </span>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Update table counts
            document.getElementById('showing-count').textContent = students.length;
            document.getElementById('total-count').textContent = students.length;
        }

        // Load attendance students function
        async function loadAttendanceStudents() {
            try {
                // Show loading state
                const btn = document.querySelector('#attendance .btn-success');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span class="loading"></span> Loading...';
                btn.disabled = true;
                
                const academicYear = document.getElementById('attendance-academic-year').value;
                const courseType = document.getElementById('attendance-course-type').value;
                const course = document.getElementById('attendance-course').value;
                const branch = document.getElementById('attendance-branch').value;
                const academicYearFilter = document.getElementById('attendance-academic-year-filter').value;

                // ✅ Validation: At least one filter must be selected
                if (!academicYear && !courseType && !course && !branch && !academicYearFilter) {
                    alert('⚠️ Please select the filter (Branch, Course Type, Course, Academic Year, or Admission Year) before loading students.');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }

                // Get today's date in DD/MM/YYYY format
                const today = new Date();
                const formattedDate = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;
                
                // Build query for students - USE CORRECT FIELD NAMES
                let query = supabase.from('students').select('*');
                
                // Apply filters - MATCH YOUR DATABASE COLUMNS
                if (academicYear) query = query.eq('admissionyear', academicYear);
                if (courseType) query = query.eq('coursetype', courseType);
                if (course) query = query.eq('course', course);
                if (branch) query = query.eq('branch', branch);
                if (academicYearFilter) query = query.eq('academicyear', academicYearFilter);

                
                const { data: students, error: studentsError } = await query;
                
                if (studentsError) {
                    console.error('Students query error:', studentsError);
                    throw studentsError;
                }
                
                console.log('Loaded students:', students);
                
                // ✅ Check if attendance already exists for this date AND selected filters
                let attendanceQuery = supabase
                    .from('attendances')
                    .select('*')
                    .eq('date', formattedDate);

                // Apply the SAME filters to attendance check
                if (branch) attendanceQuery = attendanceQuery.eq('branch', branch);

                const { data: existingAttendance, error: attendanceError } = await attendanceQuery;
                
                if (attendanceError) {
                    console.error('Attendance query error:', attendanceError);
                    throw attendanceError;
                }
                
                console.log('Existing attendance:', existingAttendance);
                
                // Update attendance table
                const tableBody = document.getElementById('attendanceTableBody');
                tableBody.innerHTML = '';
                
                if (!students || students.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No students found for the selected filters</td></tr>';
                    document.getElementById('total-attendance-count').textContent = '0';
                    document.getElementById('present-count').textContent = '0';
                    document.getElementById('absent-count').textContent = '0';
                    
                    // Restore button
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }
                
                students.forEach((student) => {
                    const row = document.createElement('tr');
                    
                    // ✅ Check if attendance exists for THIS SPECIFIC student (date + register + branch)
                    let existingStatus = null;
                    if (existingAttendance && existingAttendance.length > 0) {
                        const studentAttendance = existingAttendance.find(a => 
                            a.register_number === student.registernumber && 
                            a.branch === student.branch
                        );
                        if (studentAttendance) {
                            existingStatus = studentAttendance.status;
                        }
                    }
                    
                    row.innerHTML = `
                        <td>${student.name}</td>
                        <td>${student.registernumber || ''}</td>
                        <td>${student.branch || ''}</td>
                        <td>
                            <div class="attendance-options">
                                <div class="attendance-btn present-btn ${existingStatus === 'present' ? 'selected' : ''}" 
                                     data-student-register="${student.registernumber}"
                                     data-student-branch="${student.branch}"
                                     onclick="markAttendance(this, 'present')">P</div>
                                <div class="attendance-btn absent-btn ${existingStatus === 'absent' ? 'selected' : ''}" 
                                     data-student-register="${student.registernumber}"
                                     data-student-branch="${student.branch}"
                                     onclick="markAttendance(this, 'absent')">A</div>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                    
                    // Initialize the row's data-attendance attribute if attendance exists
                    if (existingStatus) {
                        row.setAttribute('data-attendance', existingStatus);
                    }
                });
                
                // Update attendance counts
                document.getElementById('total-attendance-count').textContent = students.length;
                updateAttendanceCounts();
                
                // Show/hide buttons based on whether attendance exists
                if (existingAttendance && existingAttendance.length > 0) {
                    document.getElementById('edit-attendance-btn').style.display = 'block';
                    document.getElementById('submit-attendance-btn').style.display = 'none';
                    document.getElementById('update-attendance-btn').style.display = 'none';
                    document.getElementById('mark-all-present-btn').style.display = 'none';
                    document.getElementById('attendance-card').classList.add('attendance-readonly');
                } else {
                    document.getElementById('edit-attendance-btn').style.display = 'none';
                    document.getElementById('submit-attendance-btn').style.display = 'inline-flex';
                    document.getElementById('update-attendance-btn').style.display = 'none';
                    document.getElementById('mark-all-present-btn').style.display = 'inline-flex';
                    document.getElementById('attendance-card').classList.remove('attendance-readonly');
                }
                
                // Restore button
                btn.innerHTML = originalText;
                btn.disabled = false;
                
            } catch (error) {
                console.error('Error loading attendance students:', error);
                alert('Error loading students for attendance: ' + (error.message || 'Please try again.'));
                
                // Restore button
                const btn = document.querySelector('#attendance .btn-success');
                btn.innerHTML = '<i class="fas fa-filter"></i> Load Students';
                btn.disabled = false;
            }
        }

        // Enable attendance editing
        function enableAttendanceEditing() {
            document.getElementById('attendance-card').classList.remove('attendance-readonly');
            document.getElementById('edit-attendance-btn').style.display = 'none';
            document.getElementById('update-attendance-btn').style.display = 'inline-flex';
            document.getElementById('mark-all-present-btn').style.display = 'inline-flex';
        }

        // Mark attendance for a student
        function markAttendance(element, status) {
            if (document.getElementById('attendance-card').classList.contains('attendance-readonly')) {
                return; // Don't allow changes in read-only mode
            }
            
            const studentRegister = element.getAttribute('data-student-register');
            const row = element.closest('tr');
            
            // Reset all buttons in this row
            const buttons = row.querySelectorAll('.attendance-btn');
            buttons.forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Mark the selected button
            element.classList.add('selected');
            
            // Store the attendance status in a data attribute
            row.setAttribute('data-attendance', status);
            
            updateAttendanceCounts();
        }

        // Update attendance counts
        function updateAttendanceCounts() {
            const rows = document.querySelectorAll('#attendanceTableBody tr');
            let presentCount = 0;
            let absentCount = 0;
            
            rows.forEach(row => {
                const attendance = row.getAttribute('data-attendance');
                if (attendance === 'present') {
                    presentCount++;
                } else if (attendance === 'absent') {
                    absentCount++;
                }
            });
            
            document.getElementById('present-count').textContent = presentCount;
            document.getElementById('absent-count').textContent = absentCount;
        }

        // Mark all students as present
        function markAllPresent() {
            if (document.getElementById('attendance-card').classList.contains('attendance-readonly')) {
                alert('⚠️ Attendance is already submitted. Click the edit button to modify.');
                return;
            }
            
            if (!confirm('Mark all students as PRESENT?')) {
                return;
            }
            
            const rows = document.querySelectorAll('#attendanceTableBody tr');
            
            rows.forEach(row => {
                const presentBtn = row.querySelector('.present-btn');
                const absentBtn = row.querySelector('.absent-btn');
                
                // Clear all selections
                presentBtn.classList.remove('selected');
                absentBtn.classList.remove('selected');
                
                // Mark as present
                presentBtn.classList.add('selected');
                row.setAttribute('data-attendance', 'present');
            });
            
            updateAttendanceCounts();
            
            alert('✅ All students marked as PRESENT! You can now change individual students to absent if needed.');
        }

        // Submit attendance
        async function submitAttendance() {
            const rows = document.querySelectorAll('#attendanceTableBody tr');

            // Get today's date in DD/MM/YYYY format
            const today = new Date();
            const formattedDate = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;
            
            // Check if all students have attendance marked
            let allMarked = true;
            rows.forEach(row => {
                if (!row.getAttribute('data-attendance')) {
                    allMarked = false;
                }
            });
            
            if (!allMarked) {
                alert('Please mark attendance for all students before submitting.');
                return;
            }
            
            try {
                // Show loading state
                const btn = document.getElementById('submit-attendance-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span class="loading"></span> Submitting...';
                btn.disabled = true;
                
                // Create attendance records
                const attendanceRecords = [];
                
                rows.forEach(row => {
                    const studentName = row.cells[0].textContent.trim();
                    const registerNo = row.cells[1].textContent.trim();
                    const studentBranch = row.cells[2].textContent.trim();
                    const attendanceStatus = row.getAttribute('data-attendance');
                    
                    attendanceRecords.push({
                        date: formattedDate,
                        branch: studentBranch,
                        student_name: studentName,
                        register_number: registerNo,
                        status: attendanceStatus,
                        created_at: new Date().toISOString()
                    });
                });
                
                console.log('Submitting attendance:', attendanceRecords);
                
                // Insert into Supabase
                const { data, error } = await supabase
                    .from('attendances')
                    .insert(attendanceRecords);
                
                if (error) {
                    console.error('Supabase insert error:', error);
                    throw error;
                }
                
                alert('Attendance submitted successfully!');
                
                // Reset to read-only mode
                document.getElementById('edit-attendance-btn').style.display = 'block';
                document.getElementById('submit-attendance-btn').style.display = 'none';
                document.getElementById('attendance-card').classList.add('attendance-readonly');
                
                // Restore button
                btn.innerHTML = originalText;
                btn.disabled = false;
                
            } catch (error) {
                console.error('Error submitting attendance:', error);
                alert('Error submitting attendance: ' + (error.message || 'Please try again.'));
                
                // Restore button
                const btn = document.getElementById('submit-attendance-btn');
                btn.innerHTML = '<i class="fas fa-check"></i> Submit Attendance';
                btn.disabled = false;
            }
        }

        // Update attendance
        async function updateAttendance() {
            const rows = document.querySelectorAll('#attendanceTableBody tr');
            
            // Get today's date in DD/MM/YYYY format
            const today = new Date();
            const formattedDate = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;
            
            // Check if all students have attendance marked
            let allMarked = true;
            rows.forEach(row => {
                if (!row.getAttribute('data-attendance')) {
                    allMarked = false;
                }
            });
            
            if (!allMarked) {
                alert('Please mark attendance for all students before updating.');
                return;
            }
            
            try {
                // Show loading state
                const btn = document.getElementById('update-attendance-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span class="loading"></span> Updating...';
                btn.disabled = true;
                
                console.log('🔄 Starting update for date:', formattedDate);
                
                let successCount = 0;
                let errorCount = 0;
                let notFoundCount = 0;
                
                // Update each student's attendance individually
                for (const row of rows) {
                    const studentName = row.cells[0].textContent.trim();
                    const registerNo = row.cells[1].textContent.trim();
                    const studentBranch = row.cells[2].textContent.trim();
                    const attendanceStatus = row.getAttribute('data-attendance');
                    
                    console.log(`Updating: ${studentName} (${registerNo}) - Branch: ${studentBranch} to ${attendanceStatus}`);
                    
                    try {
                        // Find existing record by date, register_number, AND branch
                        const { data: existingRecord, error: checkError } = await supabase
                            .from('attendances')
                            .select('id, status')
                            .eq('date', formattedDate)
                            .eq('register_number', registerNo)
                            .eq('branch', studentBranch)
                            .single();
                        
                        if (checkError) {
                            if (checkError.code === 'PGRST116') {
                                console.log(`❌ Record not found for ${studentName} (${registerNo}) - ${studentBranch}`);
                                notFoundCount++;
                                continue;
                            }
                            throw checkError;
                        }
                        
                        console.log(`✅ Found record ID ${existingRecord.id} for ${studentName}`);
                        
                        // Update the existing record by ID
                        const { data: updateData, error: updateError } = await supabase
                            .from('attendances')
                            .update({
                                status: attendanceStatus,
                                student_name: studentName,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', existingRecord.id)
                            .select();
                        
                        if (updateError) {
                            console.error(`❌ Error updating ${studentName}:`, updateError);
                            errorCount++;
                        } else {
                            successCount++;
                            console.log(`✅ Updated ${studentName}: ${existingRecord.status} → ${attendanceStatus}`);
                        }
                        
                    } catch (err) {
                        console.error(`❌ Error processing ${studentName}:`, err);
                        errorCount++;
                    }
                }
                
                // Show results
                console.log(`📊 Update Summary: ✅ ${successCount} updated, ❌ ${errorCount} errors, 🔍 ${notFoundCount} not found`);
                
                if (notFoundCount > 0) {
                    alert(`⚠️ Some records were not found:\n✅ ${successCount} records updated\n❌ ${errorCount} errors\n🔍 ${notFoundCount} not found in database`);
                } else if (errorCount > 0) {
                    alert(`⚠️ Update completed with errors:\n✅ ${successCount} records updated\n❌ ${errorCount} records failed`);
                } else {
                    alert(`✅ Attendance updated successfully!\n${successCount} records updated.`);
                }
                
                // Reset to read-only mode
                document.getElementById('edit-attendance-btn').style.display = 'block';
                document.getElementById('update-attendance-btn').style.display = 'none';
                document.getElementById('attendance-card').classList.add('attendance-readonly');
                
                // Restore button
                btn.innerHTML = originalText;
                btn.disabled = false;
                
            } catch (error) {
                console.error('❌ Error updating attendance:', error);
                alert('Error updating attendance: ' + (error.message || 'Please try again.'));
                
                // Restore button
                const btn = document.getElementById('update-attendance-btn');
                btn.innerHTML = '<i class="fas fa-sync-alt"></i> Update Attendance';
                btn.disabled = false;
            }
        }

        // Set default date range for reports (last 30 days)
        function setDefaultDateRange() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            
            document.getElementById('start-date').valueAsDate = startDate;
            document.getElementById('end-date').valueAsDate = endDate;
        }

        // Set date range to today
        function setTodayRange() {
            const today = new Date();
            document.getElementById('start-date').valueAsDate = today;
            document.getElementById('end-date').valueAsDate = today;
        }

        // Generate report function
        async function generateReport() {
            try {
                // Show loading state
                const btn = document.querySelector('#reports .btn-success');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span class="loading"></span> Generating...';
                btn.disabled = true;
                
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                const academicYear = document.getElementById('report-academic-year').value;
                const courseType = document.getElementById('report-course-type').value;
                const course = document.getElementById('report-course').value;
                const branch = document.getElementById('report-branch').value;
                const academicYearFilter = document.getElementById('report-academic-year-filter').value;

                if (!startDate || !endDate) {
                    alert('Please select date range');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }
                
                // Build query for students
                let studentQuery = supabase.from('students').select('*');
                
                // Apply filters - USE CORRECT FIELD NAMES
                if (academicYear) studentQuery = studentQuery.eq('admissionyear', academicYear);
                if (courseType) studentQuery = studentQuery.eq('coursetype', courseType);
                if (course) studentQuery = studentQuery.eq('course', course);
                if (branch) studentQuery = studentQuery.eq('branch', branch);
                if (academicYearFilter) studentQuery = studentQuery.eq('academicyear', academicYearFilter);

                const { data: students, error: studentsError } = await studentQuery;
                
                if (studentsError) {
                    console.error('Students query error:', studentsError);
                    throw studentsError;
                }
                
                console.log('Students loaded:', students);
                
                // Get attendance data for the date range
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                // Generate all dates in range in DD/MM/YYYY format
                const dateArray = [];
                const currentDate = new Date(start);
                
                while (currentDate <= end) {
                    const formattedDate = `${String(currentDate.getDate()).padStart(2, '0')}/${String(currentDate.getMonth() + 1).padStart(2, '0')}/${currentDate.getFullYear()}`;
                    dateArray.push(formattedDate);
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                console.log('Date range:', dateArray);
                
                // Build attendance query
                let attendanceQuery = supabase
                    .from('attendances')
                    .select('*')
                    .in('date', dateArray);
                
                // Apply branch filter if specified
                if (branch) {
                    attendanceQuery = attendanceQuery.eq('branch', branch);
                }
                
                const { data: attendanceData, error: attendanceError } = await attendanceQuery;
                
                if (attendanceError) {
                    console.error('Attendance query error:', attendanceError);
                    throw attendanceError;
                }
                
                console.log('Attendance data loaded:', attendanceData);
                
                // Generate report data
                const reportData = generateReportData(students || [], attendanceData || [], startDate, endDate);
                
                displayReport(reportData, startDate, endDate);
                
                // Restore button
                btn.innerHTML = originalText;
                btn.disabled = false;
                
            } catch (error) {
                console.error('Error generating report:', error);
                alert('Error generating report: ' + (error.message || 'Please try again.'));
                
                // Restore button
                const btn = document.querySelector('#reports .btn-success');
                btn.innerHTML = '<i class="fas fa-chart-bar"></i> Show Report';
                btn.disabled = false;
            }
        }

        // Generate report data from Supabase data
        function generateReportData(students, attendanceData, startDate, endDate) {
            const reportData = [];
            const uniqueDates = new Set();

            attendanceData.forEach(record => {
                uniqueDates.add(record.date);
            });

            const totalWorkingDays = uniqueDates.size;

            students.forEach(student => {
                let presentDays = 0;
                let totalDaysForStudent = 0;

                // FIXED: Use correct field names (register_number vs register_no)
                const studentAttendance = attendanceData.filter(
                    record => record.register_number === student.registernumber // Changed
                );

                studentAttendance.forEach(record => {
                    totalDaysForStudent++;
                    if (record.status === 'present') {
                        presentDays++;
                    }
                });

                const absentDays = totalDaysForStudent - presentDays;
                const presentPercent = totalDaysForStudent > 0 ? (presentDays / totalDaysForStudent * 100).toFixed(2) : "0.00";
                const absentPercent = totalDaysForStudent > 0 ? (absentDays / totalDaysForStudent * 100).toFixed(2) : "0.00";

                reportData.push({
                    name: student.name,
                    registerNo: student.registernumber,
                    branch: student.branch,
                    academicYear: student.academicyear,
                    totalDays: totalDaysForStudent,
                    presentDays: presentDays,
                    absentDays: absentDays,
                    presentPercent: presentPercent,
                    absentPercent: absentPercent
                });
            });

            if (reportData.length > 0) {
                reportData[0].totalWorkingDays = totalWorkingDays;
            }

            return reportData;
        }

        // Display report data
        function displayReport(reportData, startDate, endDate) {
            const reportTableBody = document.getElementById('reportTableBody');
            const reportTableHeader = document.getElementById('reportTableHeader');
            const reportSummary = document.getElementById('reportSummary');
            
            reportTableBody.innerHTML = '';
            
            const isSingleDay = startDate === endDate;
            
            // Format dates at the beginning
            const formattedStartDate = new Date(startDate).toLocaleDateString('en-GB');
            const formattedEndDate = new Date(endDate).toLocaleDateString('en-GB');
            
            if (isSingleDay) {
                // Today's report format
                reportSummary.innerHTML = `
                    <h3>Attendance Report for ${formattedStartDate}</h3>
                    <div class="stats-container">
                        <div class="stat-card blue">
                            <div class="stat-value">${reportData.length}</div>
                            <div class="stat-label">Total Students</div>
                        </div>
                        <div class="stat-card green">
                            <div class="stat-value">${reportData.filter(s => s.presentDays > 0).length}</div>
                            <div class="stat-label">Total Present</div>
                        </div>
                        <div class="stat-card red">
                            <div class="stat-value">${reportData.filter(s => s.presentDays === 0).length}</div>
                            <div class="stat-label">Total Absent</div>
                        </div>
                    </div>
                `;
                
                // Update table headers for today's report
                reportTableHeader.innerHTML = `
                    <th>Name</th>
                    <th>Register No</th>
                    <th>Branch</th>
                    <th>Academic Year</th>
                    <th>Status</th>
                `;
                
                reportData.forEach(student => {
                    const row = document.createElement('tr');
                    const status = student.presentDays > 0 ? 'Present' : 'Absent';
                    const statusClass = student.presentDays > 0 ? 'present' : 'absent';
                    
                    row.innerHTML = `
                        <td>${student.name}</td>
                        <td>${student.registerNo}</td>
                        <td>${student.branch}</td>
                        <td>${student.academicYear}</td>
                        <td><span class="status-badge ${statusClass}">${status}</span></td>
                    `;
                    reportTableBody.appendChild(row);
                });
                
                // Add summary totals row
                const summaryRow = document.createElement('tr');
                summaryRow.style.fontWeight = '700';
                summaryRow.style.background = '#f5f5f5';
                summaryRow.style.borderTop = '3px solid #1976d2';
                summaryRow.innerHTML = `
                    <td colspan="3" style="text-align: right; padding-right: 20px;">TOTAL:</td>
                    <td><strong>${reportData.length}</strong> Students</td>
                    <td>
                        <strong>${reportData.filter(s => s.presentDays > 0).length}</strong> Present | 
                        <strong>${reportData.filter(s => s.presentDays === 0).length}</strong> Absent
                    </td>
                `;
                reportTableBody.appendChild(summaryRow);
                
            } else {
                // Range report format
                const totalWorkingDays = reportData[0] ? reportData[0].totalWorkingDays || 0 : 0;
                
                reportSummary.innerHTML = `
                    <h3>Attendance Report from ${formattedStartDate} to ${formattedEndDate}</h3>
                    <div class="stats-container">
                        <div class="stat-card purple">
                            <div class="stat-value">${totalWorkingDays}</div>
                            <div class="stat-label">Total Working Days</div>
                        </div>
                        <div class="stat-card cyan">
                            <div class="stat-value">${reportData.length}</div>
                            <div class="stat-label">Total Students</div>
                        </div>
                        <div class="stat-card yellow">
                            <div class="stat-value">${reportData.reduce((sum, s) => sum + s.presentDays, 0)}</div>
                            <div class="stat-label">Total Present</div>
                        </div>
                        <div class="stat-card pink">
                            <div class="stat-value">${reportData.reduce((sum, s) => sum + s.absentDays, 0)}</div>
                            <div class="stat-label">Total Absent</div>
                        </div>
                    </div>
                `;
                
                // Ensure table headers are correct for range report
                reportTableHeader.innerHTML = `
                    <th>Name</th>
                    <th>Register No</th>
                    <th>Branch</th>
                    <th>Academic Year</th>
                    <th>Total Present Days</th>
                    <th>Total Absent Days</th>
                    <th>Present %</th>
                    <th>Absent %</th>
                `;
                
                reportData.forEach(student => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${student.name}</td>
                        <td>${student.registerNo}</td>
                        <td>${student.branch}</td>
                        <td>${student.academicYear}</td>
                        <td>${student.presentDays}</td>
                        <td>${student.absentDays}</td>
                        <td>${student.presentPercent}%</td>
                        <td>${student.absentPercent}%</td>
                    `;
                    reportTableBody.appendChild(row);
                });
                
                // Add summary totals row for range report
                const totalPresent = reportData.reduce((sum, s) => sum + s.presentDays, 0);
                const totalAbsent = reportData.reduce((sum, s) => sum + s.absentDays, 0);
                const avgPresentPercent = (totalPresent / (totalPresent + totalAbsent) * 100).toFixed(2);
                
                const summaryRow = document.createElement('tr');
                summaryRow.style.fontWeight = '700';
                summaryRow.style.background = '#f5f5f5';
                summaryRow.style.borderTop = '3px solid #1976d2';
                summaryRow.innerHTML = `
                    <td colspan="3" style="text-align: right; padding-right: 20px;">TOTAL:</td>
                    <td><strong>${reportData.length}</strong> Students</td>
                    <td><strong>${totalPresent}</strong></td>
                    <td><strong>${totalAbsent}</strong></td>
                    <td colspan="2"><strong>${avgPresentPercent}%</strong> Average</td>
                `;
                reportTableBody.appendChild(summaryRow);
            }
            
            // Update table counts
            document.getElementById('report-showing-count').textContent = reportData.length;
            document.getElementById('report-total-count').textContent = reportData.length;
        }

        // Open export modal
        function openExportModal() {
            document.getElementById('exportModal').style.display = 'flex';
        }

        // Close export modal
        function closeExportModal() {
            document.getElementById('exportModal').style.display = 'none';
        }

        // Export report
        function exportReport(format) {
            const reportTableBody = document.getElementById('reportTableBody');
            const rows = reportTableBody.querySelectorAll('tr');
            
            if (rows.length === 0) {
                alert('No data to export. Please generate a report first.');
                return;
            }
            
            // Get headers
            const headers = [];
            document.querySelectorAll('#reportTableHeader th').forEach(th => {
                headers.push(th.textContent);
            });
            
            // Get data (exclude summary row)
            const data = [headers];
            rows.forEach(row => {
                // Skip summary row (check if it has fontWeight bold style)
                if (row.style.fontWeight === '700') return;
                
                const rowData = [];
                row.querySelectorAll('td').forEach(cell => {
                    // Clean text - remove HTML tags and extra spaces
                    let text = cell.textContent.replace(/Present|Absent|PRESENT|ABSENT/g, '').trim();
                    // Handle status badges
                    if (cell.querySelector('.status-badge')) {
                        text = cell.querySelector('.status-badge').textContent.trim();
                    }
                    rowData.push(text);
                });
                if (rowData.length > 0) {
                    data.push(rowData);
                }
            });
            
            // Create CSV content with proper escaping
            const csvContent = data.map(row => 
                row.map(cell => {
                    // Escape quotes and wrap in quotes if contains comma
                    const cellStr = String(cell).replace(/"/g, '""');
                    return cellStr.includes(',') || cellStr.includes('\n') ? `"${cellStr}"` : cellStr;
                }).join(',')
            ).join('\n');
            
            // Set file details based on format
            let mimeType, fileName, fileExtension;
            
            if (format === 'xlsx') {
                // For Excel, use CSV with .csv extension (Excel opens CSV perfectly)
                mimeType = 'text/csv;charset=utf-8;';
                fileExtension = 'csv';
                fileName = `attendance_report_${new Date().toISOString().split('T')[0]}.${fileExtension}`;
            } else {
                // For CSV
                mimeType = 'text/csv;charset=utf-8;';
                fileExtension = 'csv';
                fileName = `attendance_report_${new Date().toISOString().split('T')[0]}.${fileExtension}`;
            }
            
            // Add BOM for Excel UTF-8 support
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: mimeType });
            
            // Download file
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            closeExportModal();
            alert(`Report exported successfully as ${format.toUpperCase()}!`);
        }

        // Modal functions
        function openVerificationModal(studentId) {
            document.getElementById('verificationModal').style.display = 'flex';
            currentStudentId = studentId;
        }

        function closeVerificationModal() {
            document.getElementById('verificationModal').style.display = 'none';
            currentStudentId = null;
            
            // Reset the verify button state
            const verifyBtn = document.querySelector('#verificationModal .btn-success');
            verifyBtn.innerHTML = 'Verify';
            verifyBtn.disabled = false;
        }

        // Verify student in Supabase
        async function verifyStudent() {
            if (!currentStudentId) return;

            try {
                // Show loading in the modal button
                const verifyBtn = document.querySelector('#verificationModal .btn-success');
                const originalText = verifyBtn.innerHTML;
                verifyBtn.innerHTML = '<span class="loading"></span> Verifying...';
                verifyBtn.disabled = true;

                const { error } = await supabase
                    .from('students')
                    .update({ 
                        verification: 'VERIFIED',
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentStudentId);

                if (error) {
                    console.error('Verification error:', error);
                    throw error;
                }

                // Refresh the student list
                await loadStudents();

                // Close modal and show success message
                closeVerificationModal();
                alert('Student verified successfully!');

                // Restore button state
                verifyBtn.innerHTML = originalText;
                verifyBtn.disabled = false;

            } catch (error) {
                console.error('Error verifying student:', error);
                alert('Error verifying student: ' + (error.message || 'Please try again.'));

                // Restore button state even on error
                const verifyBtn = document.querySelector('#verificationModal .btn-success');
                verifyBtn.innerHTML = 'Verify';
                verifyBtn.disabled = false;
            }
        }

        function openAddStudentModal() {
            document.getElementById('addStudentModal').style.display = 'flex';
            document.getElementById('addStudentForm').reset();
            // Reset dynamic dropdowns
            document.getElementById('addCourse').innerHTML = '<option value="">Select Course</option>';
            document.getElementById('addBranch').innerHTML = '<option value="">Select Branch</option>';
        }

        function closeAddStudentModal() {
            document.getElementById('addStudentModal').style.display = 'none';
        }

        function openEditStudentModal(studentId) {
            // Store the student ID for editing
            currentStudentId = studentId;
            
            // Get the student data
            const row = document.querySelector(`[onclick="openEditStudentModal('${studentId}')"]`).closest('tr');
            const cells = row.querySelectorAll('td');
            
            // Populate the edit form
            document.getElementById('name').value = cells[1].textContent;
            document.getElementById('rollNo').value = cells[2].textContent;
            document.getElementById('registerNo').value = cells[3].textContent;
            document.getElementById('admissionYear').value = cells[4].textContent;
            
            // Set the course type and trigger change to load courses
            const courseType = cells[5].textContent;
            document.getElementById('addCourseType').value = courseType;
            updateAddCourseOptions();
            
            // Set course and trigger change to load branches
            const course = cells[6].textContent;
            setTimeout(() => {
                document.getElementById('addCourse').value = course;
                updateAddBranchOptions();
                
                // Set branch
                setTimeout(() => {
                    document.getElementById('addBranch').value = cells[7].textContent;
                }, 100);
            }, 100);
            
            // Set academic year
            document.getElementById('academicYear').value = cells[8].textContent;
            
            // Change modal title and button text
            document.querySelector('#addStudentModal .modal-title').textContent = 'Edit Student';
            document.querySelector('#addStudentModal .btn-success').textContent = 'Update Student';
            document.querySelector('#addStudentModal .btn-success').onclick = updateStudent;
            
            // Open modal
            document.getElementById('addStudentModal').style.display = 'flex';
        }

        async function addStudent() {
            const form = document.getElementById('addStudentForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const newStudent = {
                name: document.getElementById('name').value,
                rollnumber: document.getElementById('rollNo').value,
                registernumber: document.getElementById('registerNo').value,
                admissionyear: document.getElementById('admissionYear').value,
                coursetype: document.getElementById('addCourseType').value,
                course: document.getElementById('addCourse').value,
                branch: document.getElementById('addBranch').value,
                academicyear: document.getElementById('academicYear').value,
                verification: 'UNVERIFIED',
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };

            try {
                // Show loading state
                const btn = document.querySelector('#addStudentModal .btn-success');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span class="loading"></span> Adding...';
                btn.disabled = true;

                const { data, error } = await supabase
                    .from('students')
                    .insert([newStudent]);
                
                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }
                
                loadStudents();
                closeAddStudentModal();
                
                alert('Student added successfully!');
                
                // Restore button
                btn.innerHTML = originalText;
                btn.disabled = false;
                
            } catch (error) {
                console.error('Error adding student:', error);
                alert('Error adding student. Please try again.');
                
                // Restore button
                const btn = document.querySelector('#addStudentModal .btn-success');
                btn.innerHTML = 'Add Student';
                btn.disabled = false;
            }
        }

        // Update student function
        async function updateStudent() {
            const form = document.getElementById('addStudentForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const updatedStudent = {
                name: document.getElementById('name').value,
                rollnumber: document.getElementById('rollNo').value,
                registernumber: document.getElementById('registerNo').value,
                admissionyear: document.getElementById('admissionYear').value,
                coursetype: document.getElementById('addCourseType').value,
                course: document.getElementById('addCourse').value,
                branch: document.getElementById('addBranch').value,
                academicyear: document.getElementById('academicYear').value,
                updated_at: new Date().toISOString()
            };

            try {
                const btn = document.querySelector('#addStudentModal .btn-success');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span class="loading"></span> Updating...';
                btn.disabled = true;

                const { data, error } = await supabase
                    .from('students')
                    .update(updatedStudent)
                    .eq('id', currentStudentId);

                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }

                loadStudents();
                closeAddStudentModal();
                alert('Student updated successfully!');

                // Reset modal
                document.querySelector('#addStudentModal .modal-title').textContent = 'Add New Student';
                btn.textContent = 'Add Student';
                btn.onclick = addStudent;

                btn.innerHTML = originalText;
                btn.disabled = false;

            } catch (error) {
                console.error('Error updating student:', error);
                alert('Error updating student. Please try again.');

                const btn = document.querySelector('#addStudentModal .btn-success');
                btn.innerHTML = 'Update Student';
                btn.disabled = false;
            }
        }

        // Import Modal Functions
        let importData = [];
        let validatedData = [];

        function openImportModal() {
            document.getElementById('importModal').style.display = 'flex';
            initializeSpreadsheet();
        }

        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
            importData = [];
            validatedData = [];
            document.getElementById('import-submit-btn').disabled = true;
            document.getElementById('validation-results').style.display = 'none';
        }

        function initializeSpreadsheet() {
            const container = document.getElementById('spreadsheet-container');
            container.innerHTML = '';
            
            // Create table
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.id = 'import-table';
            
            // Headers with "Apply to All" buttons
            const headers = ['Name', 'Roll No', 'Register No', 'Admission Year', 'Course Type', 'Course', 'Branch', 'Academic Year'];
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            headers.forEach((header, idx) => {
                const th = document.createElement('th');
                th.style.padding = '12px';
                th.style.background = '#f5f5f5';
                th.style.border = '1px solid #ddd';
                th.style.position = 'sticky';
                th.style.top = '0';
                th.style.zIndex = '10';
                
                // Add "Apply to All" button for dropdown columns
                if (idx >= 3) {
                    const btnContainer = document.createElement('div');
                    btnContainer.style.display = 'flex';
                    btnContainer.style.flexDirection = 'column';
                    btnContainer.style.gap = '5px';
                    
                    const headerText = document.createElement('div');
                    headerText.textContent = header;
                    headerText.style.fontWeight = '600';
                    
                    const applyBtn = document.createElement('button');
                    applyBtn.textContent = '↓ Apply to All';
                    applyBtn.style.padding = '4px 8px';
                    applyBtn.style.fontSize = '11px';
                    applyBtn.style.background = '#2196f3';
                    applyBtn.style.color = 'white';
                    applyBtn.style.border = 'none';
                    applyBtn.style.borderRadius = '4px';
                    applyBtn.style.cursor = 'pointer';
                    applyBtn.onclick = () => applyToAllColumn(idx);
                    applyBtn.onmouseover = function() { this.style.background = '#1976d2'; };
                    applyBtn.onmouseout = function() { this.style.background = '#2196f3'; };
                    
                    btnContainer.appendChild(headerText);
                    btnContainer.appendChild(applyBtn);
                    th.appendChild(btnContainer);
                } else {
                    th.textContent = header;
                }
                
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Body with 20 rows
            const tbody = document.createElement('tbody');
            for (let i = 0; i < 20; i++) {
                const row = document.createElement('tr');
                row.dataset.rowIndex = i;
                
                // Text inputs for Name, Roll No, Register No
                for (let j = 0; j < 3; j++) {
                    const td = document.createElement('td');
                    td.style.padding = '0';
                    td.style.border = '1px solid #ddd';
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.style.width = '100%';
                    input.style.border = 'none';
                    input.style.padding = '12px';
                    input.style.fontSize = '14px';
                    input.dataset.row = i;
                    input.dataset.col = j;
                    
                    // Add paste handler for first cell
                    if (i === 0 && j === 0) {
                        input.addEventListener('paste', handlePaste);
                        input.placeholder = 'Paste Excel data here...';
                    }
                    
                    td.appendChild(input);
                    row.appendChild(td);
                }
                
                // Admission Year dropdown
                row.appendChild(createDropdownCell(i, 3, [
                    '', '2018-2019', '2019-2020', '2020-2021', '2021-2022', 
                    '2022-2023', '2023-2024', '2024-2025'
                ]));
                
                // Course Type dropdown
                const courseTypeTd = createDropdownCell(i, 4, ['', 'UG', 'PG']);
                const courseTypeSelect = courseTypeTd.querySelector('select');
                courseTypeSelect.onchange = function() {
                    updateImportCourseDropdown(i, this.value);
                };
                row.appendChild(courseTypeTd);
                
                // Course dropdown
                const courseTd = createDropdownCell(i, 5, ['']);
                courseTd.querySelector('select').id = `course-select-${i}`;
                courseTd.querySelector('select').onchange = function() {
                    updateImportBranchDropdown(i, this.value);
                };
                row.appendChild(courseTd);
                
                // Branch dropdown
                const branchTd = createDropdownCell(i, 6, ['']);
                branchTd.querySelector('select').id = `branch-select-${i}`;
                row.appendChild(branchTd);
                
                // Academic Year dropdown
                row.appendChild(createDropdownCell(i, 7, ['', 'I', 'II', 'III', 'IV']));
                
                tbody.appendChild(row);
            }
            table.appendChild(tbody);
            container.appendChild(table);
        }

        function createDropdownCell(rowIndex, colIndex, options) {
            const td = document.createElement('td');
            td.style.padding = '0';
            td.style.border = '1px solid #ddd';
            const select = document.createElement('select');
            select.style.width = '100%';
            select.style.border = 'none';
            select.style.padding = '12px';
            select.style.fontSize = '14px';
            select.dataset.row = rowIndex;
            select.dataset.col = colIndex;
            
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt || 'Select';
                select.appendChild(option);
            });
            
            td.appendChild(select);
            return td;
        }

        function handlePaste(e) {
            e.preventDefault();
            
            const pastedText = (e.clipboardData || window.clipboardData).getData('text');
            const rows = pastedText.split('\n').map(row => row.split('\t'));
            
            console.log('Pasted data:', rows);
            
            const table = document.getElementById('import-table');
            const tbody = table.querySelector('tbody');
            const tableRows = tbody.querySelectorAll('tr');
            
            rows.forEach((rowData, rowIndex) => {
                if (rowIndex >= tableRows.length) return;
                
                const tableRow = tableRows[rowIndex];
                const inputs = tableRow.querySelectorAll('input, select');
                
                rowData.forEach((cellData, colIndex) => {
                    if (colIndex >= inputs.length) return;
                    
                    const cell = inputs[colIndex];
                    const cleanData = cellData.trim();
                    
                    if (cell.tagName === 'INPUT') {
                        cell.value = cleanData;
                    } else if (cell.tagName === 'SELECT') {
                        // Try to match dropdown value
                        const options = Array.from(cell.options);
                        const matchedOption = options.find(opt => 
                            opt.value.toLowerCase() === cleanData.toLowerCase()
                        );
                        
                        if (matchedOption) {
                            cell.value = matchedOption.value;
                            
                            // Trigger cascading dropdowns
                            if (colIndex === 4) {
                                updateImportCourseDropdown(rowIndex, matchedOption.value);
                            } else if (colIndex === 5) {
                                updateImportBranchDropdown(rowIndex, matchedOption.value);
                            }
                        }
                    }
                });
            });
            
            alert(`✅ Pasted ${rows.length} rows successfully!`);
        }

        function applyToAllColumn(colIndex) {
            const table = document.getElementById('import-table');
            const tbody = table.querySelector('tbody');
            const firstRow = tbody.querySelector('tr');
            const firstCell = firstRow.querySelectorAll('input, select')[colIndex];
            
            if (!firstCell.value) {
                alert('⚠️ Please select a value in the first row before applying to all!');
                return;
            }
            
            const valueToApply = firstCell.value;
            
            if (!confirm(`Apply "${valueToApply}" to all rows in this column?`)) {
                return;
            }
            
            const allRows = tbody.querySelectorAll('tr');
            
            allRows.forEach((row, rowIndex) => {
                const cell = row.querySelectorAll('input, select')[colIndex];
                cell.value = valueToApply;
                
                // Handle cascading dropdowns
                if (colIndex === 4) {
                    updateImportCourseDropdown(rowIndex, valueToApply);
                } else if (colIndex === 5) {
                    updateImportBranchDropdown(rowIndex, valueToApply);
                }
            });
            
            alert(`✅ Applied "${valueToApply}" to all rows!`);
        }

        function updateImportCourseDropdown(rowIndex, courseType) {
            const courseSelect = document.getElementById(`course-select-${rowIndex}`);
            courseSelect.innerHTML = '<option value="">Select</option>';
            
            if (courseType && courseOptions[courseType]) {
                courseOptions[courseType].forEach(course => {
                    const option = document.createElement('option');
                    option.value = course;
                    option.textContent = course;
                    courseSelect.appendChild(option);
                });
            }
            
            // Reset branch dropdown
            const branchSelect = document.getElementById(`branch-select-${rowIndex}`);
            branchSelect.innerHTML = '<option value="">Select</option>';
        }

        function updateImportBranchDropdown(rowIndex, course) {
            const branchSelect = document.getElementById(`branch-select-${rowIndex}`);
            branchSelect.innerHTML = '<option value="">Select</option>';
            
            if (course && branchOptions[course]) {
                branchOptions[course].forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch;
                    option.textContent = branch;
                    branchSelect.appendChild(option);
                });
            }
        }

        function validateImportData() {
            const rows = document.querySelectorAll('#spreadsheet-container tbody tr');
            const validationResults = document.getElementById('validation-results');
            validatedData = [];
            let errors = [];
            let validCount = 0;
            
            rows.forEach((row, index) => {
                const inputs = row.querySelectorAll('input, select');
                const rowData = {
                    name: inputs[0].value.trim(),
                    rollnumber: inputs[1].value.trim(),
                    registernumber: inputs[2].value.trim(),
                    admissionyear: inputs[3].value,
                    coursetype: inputs[4].value,
                    course: inputs[5].value,
                    branch: inputs[6].value,
                    academicyear: inputs[7].value
                };
                
                // Skip empty rows
                if (!rowData.name && !rowData.rollnumber && !rowData.registernumber) {
                    return;
                }
                
                // Validate required fields
                const rowErrors = [];
                if (!rowData.name) rowErrors.push('Name is required');
                if (!rowData.rollnumber) rowErrors.push('Roll No is required');
                if (!rowData.registernumber) rowErrors.push('Register No is required');
                if (!rowData.admissionyear) rowErrors.push('Admission Year must be selected');
                if (!rowData.coursetype) rowErrors.push('Course Type must be selected');
                if (!rowData.course) rowErrors.push('Course must be selected');
                if (!rowData.branch) rowErrors.push('Branch must be selected');
                if (!rowData.academicyear) rowErrors.push('Academic Year must be selected');
                
                if (rowErrors.length > 0) {
                    errors.push(`Row ${index + 1}: ${rowErrors.join(', ')}`);
                } else {
                    validatedData.push(rowData);
                    validCount++;
                }
            });
            
            // Display results
            validationResults.style.display = 'block';
            if (errors.length === 0 && validCount > 0) {
                validationResults.style.background = '#e8f5e9';
                validationResults.style.border = '1px solid #4caf50';
                validationResults.innerHTML = `
                    <p style="color: #2e7d32; font-weight: 600; margin: 0;">
                        <i class="fas fa-check-circle"></i> Validation Successful!
                    </p>
                    <p style="color: #2e7d32; margin: 10px 0 0 0;">
                        ${validCount} student(s) ready to import. Click "Import Students" to proceed.
                    </p>
                `;
                document.getElementById('import-submit-btn').disabled = false;
            } else if (errors.length > 0) {
                validationResults.style.background = '#ffebee';
                validationResults.style.border = '1px solid #f44336';
                validationResults.innerHTML = `
                    <p style="color: #c62828; font-weight: 600; margin: 0;">
                        <i class="fas fa-exclamation-triangle"></i> Validation Errors Found:
                    </p>
                    <ul style="color: #c62828; margin: 10px 0 0 20px; max-height: 150px; overflow-y: auto;">
                        ${errors.map(err => `<li>${err}</li>`).join('')}
                    </ul>
                    ${validCount > 0 ? `<p style="color: #f57c00; margin: 10px 0 0 0;">${validCount} valid rows found. Fix errors to import all data.</p>` : ''}
                `;
                document.getElementById('import-submit-btn').disabled = errors.length > 0 && validCount === 0;
            } else {
                validationResults.style.background = '#fff3e0';
                validationResults.style.border = '1px solid #ff9800';
                validationResults.innerHTML = `
                    <p style="color: #e65100; font-weight: 600; margin: 0;">
                        <i class="fas fa-info-circle"></i> No data found to import.
                    </p>
                `;
                document.getElementById('import-submit-btn').disabled = true;
            }
        }

        async function submitImportData() {
            if (validatedData.length === 0) {
                alert('Please validate data first!');
                return;
            }
            
            if (!confirm(`Import ${validatedData.length} student(s)?`)) {
                return;
            }
            
            const btn = document.getElementById('import-submit-btn');
            
            try {
                btn.innerHTML = '<span class="loading"></span> Importing...';
                btn.disabled = true;
                
                // Add verification and timestamps
                const studentsToImport = validatedData.map(student => ({
                    ...student,
                    verification: 'UNVERIFIED',
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                }));
                
                const { data, error } = await supabase
                    .from('students')
                    .insert(studentsToImport);
                
                if (error) throw error;
                
                alert(`Successfully imported ${validatedData.length} student(s)!`);
                
                // Refresh student list
                await loadStudents();
                
                // Close modal
                closeImportModal();
                
                btn.innerHTML = '<i class="fas fa-upload"></i> Import Students';
                btn.disabled = true;
                
            } catch (error) {
                console.error('Error importing students:', error);
                alert('Error importing students: ' + error.message);
                
                btn.innerHTML = '<i class="fas fa-upload"></i> Import Students';
                btn.disabled = false;
            }
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const verificationModal = document.getElementById('verificationModal');
            const addStudentModal = document.getElementById('addStudentModal');
            const exportModal = document.getElementById('exportModal');
            const importModal = document.getElementById('importModal');
            
            if (event.target === verificationModal) {
                closeVerificationModal();
            }
            
            if (event.target === addStudentModal) {
                closeAddStudentModal();
            }
            
            if (event.target === exportModal) {
                closeExportModal();
            }
            
            if (event.target === importModal) {
                closeImportModal();
            }
        }
    </script>
</body>
</html>